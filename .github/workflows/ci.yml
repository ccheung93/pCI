name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain:
          - {compiler: intel, version: '2024.1'}
          - {compiler: intel-classic, version: '2021.12'}
        openmpi:
          - {series: '4.1', version: '4.1.5'}
          - {series: '5.0', version: '5.0.3'}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Install Fortran compiler
      - name: Setup Fortran
        uses: fortran-lang/setup-fortran@v1.6.1
        with:
          compiler: ${{ matrix.toolchain.compiler }}
          version: ${{ matrix.toolchain.version }}

      # Check compiler version
      - name: Compiler Version
        run: |
          ${CC} --version
          ${CXX} --version
          ${FC} --version

      # Install Intel MKL library
      - name: Setup MKL
        run: |
          sudo apt install intel-oneapi-mkl

      # Install OpenMPI
      - name: Install OpenMPI
        run: |
          wget https://download.open-mpi.org/release/open-mpi/v${{ matrix.openmpi.series }}/openmpi-${{ matrix.openmpi.version }}.tar.gz
          tar -xzf openmpi-${{ matrix.openmpi.version }}.tar.gz
          ./openmpi-${{ matrix.openmpi.version }}/configure --prefix=/home/${USER}/openmpi CC=${CC} CXX=${CXX} FC=${FC}
          make -j$(nproc)
          make install

      # Install CMake
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v2.0.2
        with:
          cmake-version: '3.13'

      # Build the project with CMake
      - name: Build
        run: |
          export MKLROOT=/opt/intel/oneapi/mkl/latest
          export LD_LIBRARY_PATH=$MKLROOT/lib/intel64:$LD_LIBRARY_PATH
          export LIBRARY_PATH=$MKLROOT/lib/intel64:$LIBRARY_PATH
          export CPATH=$MKLROOT/include:$CPATH
          mkdir -p build
          cd build
          FC=${FC} cmake -DMPI_Fortran_COMPILER=mpifort -DMPI_HOME=/home/${USER}/openmpi -DCMAKE_INSTALL_PREFIX=$(pwd)/../ ..
          make
          make install
